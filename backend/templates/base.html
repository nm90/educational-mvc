<!--
    Base Template - Shared layout for all pages

    MVC Role: VIEW (Template)
    - This is a base template that other templates extend
    - Provides consistent layout, navigation, and styling
    - Child templates fill in the "block content" section

    Learning Purpose:
    - Demonstrates template inheritance in Jinja2
    - Shows how Views share common structure
    - Lesson 2 covers how Views display data from Controllers

    Note: Views just DISPLAY data - they contain NO business logic.
    All data comes from Controllers, all validation happens in Models.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="An interactive educational application teaching MVC architecture with real-time request flow visualization.">
    <meta name="theme-color" content="#2c3e50">
    <title>Educational MVC App - Learn MVC Architecture</title>

    <!-- Main Application Styles -->
    <link rel="stylesheet" href="/static/css/main.css">

    <!-- Developer Panel Styles -->
    <link rel="stylesheet" href="/static/css/devpanel.css">

    <!-- Lesson Panel Styles (Tutorial Mode sidebar) -->
    <link rel="stylesheet" href="/static/css/lessonPanel.css">

    <!-- Mode Manager Styles (Tutorial/Exploration toggle) -->
    <link rel="stylesheet" href="/static/css/modeManager.css">
</head>
<body>
    <!-- Skip-to-content link for screen readers and keyboard users -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <!-- Header - App title and branding -->
    <header role="banner">
        <div class="header-content">
            <h1>Educational MVC App</h1>
            <!-- Mode Toggle - Switch between Tutorial and Exploration modes -->
            <div class="mode-toggle-container" role="group" aria-labelledby="mode-label">
                <span class="mode-label" id="mode-label">Learning Mode:</span>
                <span class="mode-label">ðŸ“š Tutorial</span>
                <div class="mode-switch-wrapper">
                    <input type="checkbox" id="mode-switch" aria-label="Toggle between Tutorial Mode and Exploration Mode" aria-describedby="current-mode-badge">
                    <label for="mode-switch" class="toggle-switch"></label>
                </div>
                <span class="mode-label">ðŸ”¬ Exploration</span>
                <span class="mode-badge" id="current-mode-badge" aria-live="polite" aria-atomic="true">Tutorial Mode</span>
            </div>
        </div>
    </header>

    <!-- Navigation - Links to main sections of the app -->
    <!--
        Using Flask's request.endpoint to detect current page and highlight active nav link.
        This demonstrates conditional rendering in Jinja2 templates.
    -->
    <nav role="navigation" aria-label="Main navigation">
        <a href="/" {% if request.endpoint == 'index' %}class="active" aria-current="page"{% endif %}>Home</a>
        <a href="{{ url_for('users.index') }}" {% if request.endpoint and request.endpoint.startswith('users') %}class="active" aria-current="page"{% endif %}>Users</a>
        <a href="{{ url_for('tasks.index') }}" {% if request.endpoint and request.endpoint.startswith('tasks') %}class="active" aria-current="page"{% endif %}>Tasks</a>
    </nav>

    <main id="main-content" role="main">
        <!-- Flash Messages - Display feedback from Controller actions -->
        <!--
            Flash messages are set by Controllers (e.g., flash('User created!', 'success'))
            The View just displays them - it doesn't know why they exist
        -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages" role="region" aria-live="polite" aria-atomic="true" aria-label="Status messages">
                    {% for category, message in messages %}
                        <div class="flash {{ category }}" role="alert">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Page Content - Child templates inject their content here -->
        <!--
            This is where the specific page content goes.
            Each page template (index, show, edit, etc.) extends this base
            and fills in this block with its own content.
        -->
        {% block content %}{% endblock %}
    </main>

    <!-- Footer - App information and status -->
    <footer role="contentinfo">
        <p><strong>Educational MVC App</strong> - Learn MVC Architecture with Real-Time Request Tracing</p>
        <p>All form submissions are async with full __DEBUG__ transparency for learning</p>
    </footer>

    <!-- JavaScript for async form handling -->
    <!-- User Feedback - Toast notifications, confirmations, and loading indicators -->
    <script src="/static/js/userFeedback.js"></script>

    <!-- Mode Manager - Manages Tutorial/Exploration mode switching -->
    <script src="/static/js/modeManager.js"></script>

    <!-- MVC API Client - Handles fetch() requests with __DEBUG__ extraction -->
    <script src="/static/js/mvc-api.js"></script>

    <!-- Form Handler - Intercepts form submissions and sends async requests -->
    <script src="/static/js/mvc-forms.js"></script>

    <!-- Developer Panel - Shows full request/response flow for learning -->
    <!-- Reads window.__DEBUG__ injected by backend, displays MVC execution -->
    <script src="/static/js/devPanel.js"></script>

    <!-- Lesson Engine - Manages Tutorial Mode lessons and panel UI -->
    <script src="/static/js/lessonEngine.js"></script>

    <script>
        /**
         * Initialize Mode Manager and Lesson Engine
         *
         * MVC Flow:
         * 1. Initialize ModeManager (loads saved mode preference)
         * 2. ModeManager applies mode (shows/hides UI components)
         * 3. Initialize LessonEngine
         * 4. Listen for mode changes to adjust lesson panel visibility
         *
         * Mode Manager Usage:
         *   window.modeManager.getCurrentMode()
         *   window.modeManager.isTutorialMode()
         *   window.modeManager.isExplorationMode()
         *   window.modeManager.setMode('exploration')
         *
         * Lesson Engine Usage:
         *   window.lessonEngine.loadLesson(1)
         *   window.lessonEngine.nextStep()
         *   window.lessonEngine.previousStep()
         */

        // Initialize Mode Manager first (controls UI visibility)
        window.modeManager = new ModeManager();

        // Initialize Lesson Engine
        window.lessonEngine = new LessonEngine();

        // Update mode badge when mode changes
        window.modeManager.onModeChange((mode) => {
            const badge = document.getElementById('current-mode-badge');
            if (badge) {
                const displayName = mode === 'tutorial' ? 'Tutorial Mode' : 'Exploration Mode';
                badge.textContent = displayName;
            }
        });

        // Load lesson content when in tutorial mode
        function initializeTutorialMode() {
            if (window.modeManager.isTutorialMode() && window.lessonEngine) {
                // Load the first lesson if no lesson is currently loaded
                const progress = window.lessonEngine.loadProgress();
                if (!progress.currentLesson) {
                    // Load Lesson 1 for first-time users
                    window.lessonEngine.loadLesson(1).catch(err => {
                        console.warn('Could not load Lesson 1:', err);
                    });
                } else {
                    // Resume previous lesson
                    window.lessonEngine.loadLesson(progress.currentLesson).catch(err => {
                        console.warn('Could not resume lesson:', err);
                    });
                }
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTutorialMode);
        } else {
            initializeTutorialMode();
        }

        // Listen for mode changes and update UI accordingly
        document.addEventListener('modeChanged', (event) => {
            console.log('ðŸ“¢ Mode changed event received:', event.detail.mode);

            // If switching to tutorial mode, load lessons
            if (event.detail.mode === 'tutorial') {
                initializeTutorialMode();
            }
        });
    </script>
</body>
</html>
